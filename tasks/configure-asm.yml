---

- name:  (main/reconfigure-asm)run bash shell script do discover asm disks
  shell: "~/discover-asm-disks.sh"
  register: command_result
  failed_when: command_result.rc != 0

- name: (main/reconfigure-asm) Check ASM status
  shell: "/usr/sbin/oracleasm status | grep 'yes' | wc -l"
  register: asm_status_result
  failed_when: asm_status_result.stdout != "2"
  become: true

- name: Display ASM disks quantity
  debug:
    msg: "ASM disks quantity {{ asm_disks_quantity }}"

- name: (main/reconfigure-asm) Check ASM disks
  shell: "/usr/sbin/oracleasm listdisks | wc -l"
  register: asm_listdisks_result
  failed_when: asm_listdisks_result.stdout != "{{ asm_disks_quantity }}"
  become: true

- name: (main/reconfigure-asm) configure Grid Infrastructure for a Stand-Alone Server
  shell: "{{ oracle_grid_oracle_home }}/perl/bin/perl -I {{ oracle_grid_oracle_home }}/perl/lib -I {{ oracle_grid_oracle_home }}/crs/install {{ oracle_grid_oracle_home }}/crs/install/roothas.pl"
  register: config_result
  failed_when: config_result.stderr_lines == ""
  become: true

- name: (main/reconfigure-asm) preparing listener template
  template:
    src: "{{ role_path }}/templates/netca.rsp.j2"
    dest: "/tmp/netca.rsp"

- name: (main/reconfigure-asm) configure listener
  become: true
  become_user: "{{ service_user_name }}"
  shell: "{{ oracle_grid_oracle_home }}/bin/netca -silent -responsefile /tmp/netca.rsp"

- name: (main/reconfigure-asm) run config of asm as oracle
  become: true
  become_user: "{{ service_user_name }}"
  shell: "{{ oracle_grid_oracle_home }}/bin/asmca
            -silent
            -configureASM
            -sysAsmPassword {{ sys_asm_password|default('d3l1u5ag41n') }}
            -asmsnmpPassword {{ snmp_asm_password|default('d3l1u5ag41n') }}
            -diskString '/dev/oracleasm/disks/ASMDISK*'
            -diskGroupName DATA
            -diskList /dev/oracleasm/disks/ASMDISK1
            -redundancy EXTERNAL"
  register: asm_result
