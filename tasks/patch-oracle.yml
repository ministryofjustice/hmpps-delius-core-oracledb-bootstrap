---

- name: (main/patch-oracle) Apply latest opatch utility to 11g database and 11g grid

  block:

    - name: (main/patch-oracle) Backup Our OPatch Files
      archive:
        path: "{{ item }}"
        dest: "../{{ item|basename + '-' + ansible_date_time.epoch }}.tar.gz"
        remote_src: true
        remove: true
      with_items:
        - "{{ oracle_grid_oracle_home }}/OPatch"
        - "{{ oracle_database_oracle_home }}/OPatch"

    - name: (main/patch-oracle) Copy opatch utility to grid home
      copy:
        src: "{{ oracle_patch_installer_directory }}/p6880880_112000_Linux-x86-64.zip"
        dest: "{{ oracle_grid_oracle_home }}"
        remote_src: yes

    - name: (main/patch-oracle) Copy opatch utility to database home
      copy:
        src: "{{ oracle_patch_installer_directory }}/p6880880_112000_Linux-x86-64.zip"
        dest: "{{ oracle_database_oracle_home }}"
        remote_src: yes

    - name: (main/patch-oracle) Unpack opatch utility
      unarchive:
        src: "{{ item }}/p6880880_112000_Linux-x86-64.zip"
        dest: "{{ item }}"
        remote_src: yes
        owner: "{{ service_user_name }}"
      with_items:
        - "{{ oracle_grid_oracle_home }}"
        - "{{ oracle_database_oracle_home }}"

    - name: (main/patch-oracle) Remove our patch archives now we have unpacked them
      file:
        path: "{{ item }}"
        state: absent
      with_items:
        - "{{ oracle_grid_oracle_home }}/p6880880_112000_Linux-x86-64.zip"
        - "{{ oracle_database_oracle_home }}/p6880880_112000_Linux-x86-64.zip}}"

  when: db_version is not defined

- name: (main/patch-oracle) Apply latest opatch utility to 11g database only

  block:

    - name: (main/patch-oracle) Backup Our OPatch Files
      archive:
        path: "{{ oracle_database_oracle_home }}"
        dest: "../{{ oracle_database_oracle_home }}/OPatch |basename + '-' + ansible_date_time.epoch }}.tar.gz"
        remote_src: true
        remove: true

    - name: (main/patch-oracle) Copy opatch utility to database home
      copy:
        src: "{{ oracle_patch_installer_directory }}/p6880880_112000_Linux-x86-64.zip"
        dest: "{{ oracle_database_oracle_home }}"
        remote_src: yes

    - name: (main/patch-oracle) Unpack opatch utility
      unarchive:
        src: "{{ oracle_database_oracle_home }}/p6880880_112000_Linux-x86-64.zip"
        dest: "{{ oracle_database_oracle_home }}"
        remote_src: yes
        owner: "{{ service_user_name }}"

    - name: (main/patch-oracle) Remove our patch archives now we have unpacked them
      file:
        path: "{{ oracle_database_oracle_home }}/p6880880_112000_Linux-x86-64.zip"
        state: absent

  when: (db_version is defined) and (db_version == '11g')

